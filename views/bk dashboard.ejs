<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Visitas - MS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Estilos compartilhados -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <style>
    /* Básico */
    body { margin: 0; font-family: sans-serif; overflow: auto; height: 100vh; background: #f0f0f0; }
    /* Navbar */
    .navbar { height: 50px; background-color: #007BFF; color: white; display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar a { color: white; margin-left: 20px; text-decoration: none; font-weight: 500; }
    /* Container geral */
    .container { padding: 20px; box-sizing: border-box; }
    /* Métricas */
    .metrics { display: flex; gap: 20px; margin-bottom: 20px; }
    .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; min-width: 200px; }
    .card h2 { margin-top: 0; font-size: 1.2rem; }
    /* Mapa */
    #map-container { width: 100%; overflow: auto; display: flex; justify-content: center; position: relative; }
    #map { border: 1px solid #ccc; max-width: 100%; height: auto; }
    /* Rótulos nos municípios visitados */
    .label { font-size: 10px; fill: #000; text-anchor: middle; pointer-events: none; }
    /* Legenda de cidades */
    .legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .legend-item { display: flex; align-items: center; gap: 4px; font-size: 0.8em; }
    .legend-box { width: 16px; height: 16px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <%- include('partials/nav') %>
  <div class="container">
    <h1>Dashboard de Visitas - MS</h1>
    <div class="metrics">
      <div class="card"><h2>Distrito Mais Visitado</h2><p id="most-visited">Carregando...</p></div>
      <div class="card"><h2>Distrito Menos Visitado</h2><p id="least-visited">Carregando...</p></div>
    </div>
    <div id="map-container">
      <svg id="map" width="800" height="600"></svg>
    </div>
    <div id="legend" class="legend"></div>
  </div>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const width = 800, height = 600;
    const svg = d3.select('#map');
    const projection = d3.geoMercator().scale(4300).center([-54.6201, -20.4697]).translate([width/2, height/2]);
    const path = d3.geoPath().projection(projection);

    Promise.all([
      d3.json('ms_municipios.geojson'),
      fetch('/calendar/api/visits-count').then(res => res.json())
    ]).then(([municipios, visitsCount]) => {
      const entries = Object.entries(visitsCount);
      const counts = entries.map(([,c]) => c);
      const min = d3.min(counts) || 0;
      const max = d3.max(counts) || 1;
      const colorScale = d3.scaleSequential().domain([min, max]).interpolator(d3.interpolateYlOrRd);

      // Desenha municípios
      svg.selectAll('path.municipio')
        .data(municipios.features)
        .enter().append('path')
          .attr('class', 'municipio')
          .attr('d', path)
          .attr('fill', d => {
            const c = visitsCount[d.properties.name] || 0;
            return c === 0 ? '#eee' : colorScale(c);
          })
          .attr('stroke', '#333').attr('stroke-width', 0.5)
          .attr('title', d => `${d.properties.name}: ${visitsCount[d.properties.name] || 0} visitas`)
          .on('click', (event, d) => {
            const c = visitsCount[d.properties.name] || 0;
            document.getElementById('most-visited').textContent = `${d.properties.name} (${c} visitas)`;
          });

      // Rótulos para municípios visitados
      const visited = municipios.features.filter(d => visitsCount[d.properties.name] > 0);
      svg.selectAll('text.label')
        .data(visited)
        .enter().append('text')
          .attr('class', 'label')
          .attr('transform', d => `translate(${path.centroid(d)})`)
          .text(d => d.properties.name);

      // Atualiza métricas
      const sorted = entries.sort((a,b) => b[1] - a[1]);
      if (sorted.length) {
        document.getElementById('most-visited').textContent = `${sorted[0][0]} (${sorted[0][1]} visitas)`;
        document.getElementById('least-visited').textContent = `${sorted[sorted.length-1][0]} (${sorted[sorted.length-1][1]} visitas)`;
      } else {
        document.getElementById('most-visited').textContent = 'Sem dados';
        document.getElementById('least-visited').textContent = 'Sem dados';
      }

      // Monta legenda de cidades
      const legend = d3.select('#legend');
      sorted.forEach(([name, count]) => {
        legend.append('div').attr('class', 'legend-item').html(
          `<div class="legend-box" style="background:${colorScale(count)}"></div><span>${name} (${count})</span>`
        );
      });
    }).catch(err => console.error('Erro dashboard:', err));
  </script>
</body>
</html>
